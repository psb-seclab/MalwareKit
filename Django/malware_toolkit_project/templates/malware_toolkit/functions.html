{% extends 'codeUI.html' %}

{% load staticfiles %}

{% block title %}{{ title }}{% endblock %}

{% block js_2 %}
<script>

function addUpdateFunction(){
  var function_name = $("#function-name").val();
  var global_vars = $("#globals-text").val();
  var imports = $("#imports-text").val();
  var declaration = $("#declaration-text").val();
  var definition = $("#definition-text").val();

  if(function_name != "" &&
      declaration != "" && definition != ""){
        globals = makeArray(replaceBadChars(global_vars));
        imports = makeArray(replaceBadChars(imports));
        declaration = makeArray(replaceBadChars(declaration));
        definition = makeArray(replaceBadChars(definition));

        var func = {
          "name": function_name,
          "global": globals,
          "import": imports,
          "declaration": declaration,
          "definition": definition
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"POST",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/add_function/",
          data: JSON.stringify(func),
          processData: false,
          success: function(msg) {
            // console.log(msg);
          }
        });
  }
}

function deleteFunction(){
  var del = confirm("Are you sure you want to permanently delete this function?");
  if(del){
    var function_name = $("#function-name").val();
    var func = {
      "name": function_name,
    };

    var csrftoken = getCookie('csrftoken');
    $.ajax({
      type:"DELETE",
      beforeSend: function (request)
      {
        request.setRequestHeader("X-CSRFToken", csrftoken);
      },
      url: "/malware_toolkit/api/function",
      data: JSON.stringify(func),
      success: function(msg) {
        if(msg == 200){
          $("#function-name").val("");
          $("#globals-text").val("");
          $("#imports-text").val("");
          $("#declaration-text").val("");
          $("#definition-text").val("");

          removeFromListByName("function-list", func['name']);
        }
      }
    });
  }
}

function replaceBadChars(data){
  var data = data.replace(/"/g, '\{\{1\}\}');
  return data.replace(/'/g, '\{\{2\}\}');
}

function restoreBadChars(data){
  for(s in data){
    data[s] = data[s].replace(/\{\{1\}\}/g, '\"');
    data[s] = data[s].replace(/\{\{2\}\}/g, '\'');
  }
  return data;
}

function getFunction(){
  var function_name = $("#function-name").val();
  if(function_name != ""){
        var func = {
          "name": function_name,
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"GET",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/api/function",
          data: func,
          success: function(msg) {
            // console.log(msg);
            func = JSON.parse(msg)
            globals = func.globals
            imports = func.imports
            header = func.header
            definition = func.definition;
            setElementText("#globals-text", restoreBadChars(globals));
            setElementText("#imports-text", restoreBadChars(imports));
            setElementText("#declaration-text", restoreBadChars(header));
            setElementText("#definition-text", restoreBadChars(definition));
          }
        });
  }
}

$(document).ready(function(){
  document.getElementById('submit-btn').addEventListener('click', addUpdateFunction);
  document.getElementById('function-delete-btn').addEventListener('click', deleteFunction);
  document.getElementById('function-name').addEventListener('input', getFunction);
});


</script>
{% endblock %}

{% block banner %}{{ title }}{% endblock %}

{% block body_block %}
  <div id="top-wrapper" class="row">

    <a href="/malware_toolkit/features">Features</a>

    <div style="clear: both"></div>

    <div class="col-md-4">
      <div id="row-1" class="row form-group">
        <label>Function:</label></br>
      </div>
        <div id="row-1-c1" class="row" style="float: left">
          <input list="function-list" id="function-name" class="form-control">
          <datalist id="function-list">
            {% for func in functions %}
              <option value="{{ func }}">
            {% endfor %}
          </datalist>
        </div>
        <div id="row-1-c2" style="float: left; padding-left:25px">
          <button id="function-delete-btn" class="btn btn-default">Delete</button>
        </div>
      <div style="clear: both"></div>
      <!-- close row-1 -->

      <div id="row-2" class="row form-group">
        <label>Global Variables:</label></br>
        <textarea id="globals-text" rows="3" class="form-control"></textarea>
      </div>
      <!-- close row-2 -->

      <div id="row-3" class="row form-group">
        <label>Imports:</label></br>
        <textarea id="imports-text" rows="5" class="form-control"></textarea>
      </div>
      <!-- close row-3 -->

      <div id="row-4" class="row form-group">
        <label>Declaration:</label></br>
        <textarea id="declaration-text" rows="5" class="form-control"></textarea>
      </div>
      <!-- close row-4 -->

      <div id="row-5" class="row form-group">
        <label>Definition:</label></br>
        <textarea id="definition-text" rows="8" class="form-control"></textarea>
      </div>
      <!-- close row-5 -->

      <div id="row-6" class="row form-group">
        <button id="submit-btn" class="btn btn-primary">Submit</button>
      </div>
      <!-- close row-6 -->

    </div>
    <!-- close column -->
  </div>
  <!-- close top-wrapper -->
{% endblock %}
